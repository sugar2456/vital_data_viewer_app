# 機能仕様書: Fitbit睡眠データの可視化

**機能ブランチ**: `001-sleep-graph`
**作成日**: 2025-11-16
**ステータス**: ドラフト
**入力**: ユーザー説明: "fitbitのweb apiを利用して睡眠データをグラフに表示したいです。縦軸は3種類の睡眠ステージ、横軸は時刻を表示したいです。右下にカレンダー アイコンを配置して、カレンダーを選択すると日付を選択するとその日の睡眠データが見れるようにしたいです。"

## 概要

この機能により、ユーザーはFitbitからの睡眠データを視覚化し、時系列での睡眠ステージを表示できます。特定の日付を選択して過去の睡眠パターンを確認することも可能です。

**注**: Fitbitには2つの睡眠データ形式があり、両方に対応します：
- **stages形式**（新しいデバイス）: deep（深い睡眠）、light（浅い睡眠）、rem（REM睡眠）、wake（覚醒）
- **classic形式**（古いデバイス）: asleep（睡眠中）、restless（不安定）、awake（起きている）

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー1 - 今日の睡眠データを表示 (優先度: P1)

ユーザーは、睡眠可視化画面を開いたときに、当日の睡眠データをすぐに確認したいと考えています。これにより、前夜の睡眠の質を理解できます。

**この優先度の理由**: これは最も一般的な使用例です。ユーザーは主に最新の睡眠データを確認したいと考えています。これがなければ、この機能は即座の価値を提供できません。

**独立テスト**: 睡眠可視化画面を開き、今日の睡眠データが横方向タイムライン形式で表示され、各睡眠ステージが時刻に沿って連続的に表示されることを確認することで、完全にテストできます。

**受入シナリオ**:

1. **前提条件**: ユーザーのFitbitアカウントに今日の睡眠データがある
   **操作**: ユーザーが睡眠可視化画面を開く
   **期待結果**: グラフに今日の日付の睡眠ステージが横方向タイムラインとして表示され、各ステージが時間軸に沿ってシームレスに配置される（stages形式またはclassic形式のいずれか）  

2. **前提条件**: ユーザーが今日複数の睡眠セッションを持っている  
   **操作**: 画面が読み込まれる  
   **期待結果**: デフォルトでメインの睡眠セッションが表示される  

3. **前提条件**: ユーザーが今日の睡眠データを持っていない  
   **操作**: 画面が読み込まれる  
   **期待結果**: 選択した日付の睡眠データがないことを示すメッセージが表示される  

---

### ユーザーストーリー2 - カレンダーで過去の睡眠データを選択 (優先度: P2)

ユーザーは、時間経過に伴うパターンの追跡、異なる夜の比較、または特定の日付の確認のために、過去の日付の睡眠データを表示したいと考えています。

**この優先度の理由**: 過去データの表示はトレンド分析に重要ですが、初期MVPには必須ではありません。ユーザーは今日のデータを表示するだけでも価値を得られます。

**独立テスト**: 右下のFloatingActionButton（カレンダーアイコン）をタップし、過去の日付を選択し、グラフがその日付の睡眠データを表示するように更新されることを確認することで、完全にテストできます。

**受入シナリオ**:

1. **前提条件**: ユーザーが睡眠可視化画面を表示している
   **操作**: ユーザーが右下のFloatingActionButton（カレンダーアイコン）をタップする
   **期待結果**: 日付ピッカーが表示される  

2. **前提条件**: 日付ピッカーが開いている  
   **操作**: ユーザーが睡眠データのある過去の日付を選択する  
   **期待結果**: グラフが選択した日付の睡眠ステージを表示するように更新される  

3. **前提条件**: ユーザーが睡眠データのない日付を選択する  
   **操作**: 選択が確定される  
   **期待結果**: その日付の睡眠データがないことを示すメッセージが表示される  

4. **前提条件**: ユーザーが過去の日付を選択している  
   **操作**: グラフを表示している  
   **期待結果**: 選択した日付が明確に表示され、混乱を避けられる  

---

### ユーザーストーリー3 - 睡眠ステージの可視化を理解する (優先度: P1)

ユーザーは、睡眠の質を評価するために、さまざまな睡眠ステージとそれらの夜間の分布を理解したいと考えています。

**この優先度の理由**: 明確なラベル付けと視覚的な区別がなければ、グラフはユーザーにとって無意味になります。これは、機能が価値を提供するために不可欠です。

**独立テスト**: 睡眠グラフを表示し、各睡眠ステージ(深い睡眠、浅い睡眠、REM睡眠、覚醒)が横方向タイムラインで明確にラベル付けされ、色によって視覚的に区別できることを確認することで、完全にテストできます。

**受入シナリオ**:

1. **前提条件**: 睡眠データが表示されている
   **操作**: ユーザーがグラフを表示する
   **期待結果**: 各睡眠ステージ（stages形式: deep/light/rem/wake、またはclassic形式: asleep/restless/awake）が横方向タイムラインの各行として表示され、各ステージが色で視覚的に区別されている

2. **前提条件**: グラフが睡眠データを表示している
   **操作**: ユーザーが時間軸を表示する
   **期待結果**: 各睡眠ステージがいつ発生したかを示すために、適切な間隔(例: 1時間ごと)で時間ラベルが横軸の下部に表示される

3. **前提条件**: ユーザーが睡眠ステージを表示している
   **操作**: グラフを見ている
   **期待結果**: 各ステージ行の横軸に沿って、そのステージに該当する時間帯が色付きのセグメントとして表示され、睡眠ステージの継続時間と遷移が明確に見える

---

### ユーザーストーリー4 - トータル睡眠時間を確認 (優先度: P1)

ユーザーは、選択した日付のトータル睡眠時間を一目で確認したいと考えています。これにより、睡眠の量を素早く把握できます。

**この優先度の理由**: トータル睡眠時間は、ユーザーが最も知りたい基本的な情報の1つです。グラフだけでは睡眠時間の総量を把握しにくいため、数値での表示が必要です。

**独立テスト**: 睡眠可視化画面を開き、画面の右上にトータル睡眠時間（例: "7時間30分"）がStackCordコンポーネントとして表示されることを確認することで、完全にテストできます。

**受入シナリオ**:

1. **前提条件**: ユーザーが睡眠データのある日付を表示している
   **操作**: 画面を確認する
   **期待結果**: トータル睡眠時間が時間と分の形式（例: "7時間30分"）で画面の右上にStackCordコンポーネントとして明確に表示される  
  
2. **前提条件**: ユーザーが日付を変更する  
   **操作**: カレンダーで別の日付を選択する  
   **期待結果**: トータル睡眠時間が選択した日付のものに更新される  

---

### エッジケース

- 選択した日付にFitbitの睡眠データがない場合はどうなりますか？
- システムは1日に複数の睡眠セッション(昼寝とメインの睡眠など)をどのように処理しますか？
- 睡眠データを表示している間にユーザーのFitbit認証が期限切れになった場合はどうなりますか？
- システムはFitbit APIからの部分的または不完全な睡眠データをどのように処理しますか？
- Fitbit APIが利用できない、またはエラーを返す場合はどうなりますか？
- システムは未来の日付をどのように処理しますか(カレンダーは選択を防ぐべきか、「データなし」を表示すべきか)？
- ユーザーのデバイスがclassic形式とstages形式の両方のデータを持っている場合はどうなりますか？
- 古いデバイス（classic形式）から新しいデバイス（stages形式）に切り替えた場合、過去のデータはどのように表示されますか？

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは指定された日付のFitbit Web APIから睡眠データを取得しなければならない
- **FR-002**: システムはstages形式（deep/light/rem/wake）とclassic形式（asleep/restless/awake）の両方の睡眠データに対応しなければならない
- **FR-003**: システムは横方向タイムラインで睡眠ステージを表示しなければならない（データ形式に応じて適切なステージを各行として表示）
- **FR-004**: システムはグラフの横軸の下部に時刻ラベルを表示しなければならない
- **FR-005**: システムは画面の右下にFloatingActionButton（カレンダーアイコン）を提供しなければならない
- **FR-006**: ユーザーはカレンダーアイコンをタップして日付ピッカーを開くことができなければならない
- **FR-007**: ユーザーは日付ピッカーから任意の過去の日付を選択できなければならない
- **FR-008**: システムは選択した日付の睡眠データを表示するようにグラフを更新しなければならない
- **FR-009**: システムは画面が読み込まれたときにデフォルトで今日の睡眠データを表示しなければならない
- **FR-010**: システムは各睡眠ステージを明確な色で視覚的に区別し、Y軸ラベルで明確にラベル付けしなければならない
- **FR-011**: システムは横軸に適切な間隔（1時間ごと）で時間ラベルを表示しなければならない
- **FR-012**: システムは選択した日付の睡眠データがない場合にメッセージを表示しなければならない
- **FR-013**: システムは選択した日付のトータル睡眠時間を画面の右上にStackCordコンポーネントとして表示しなければならない
- **FR-014**: システムはFitbit APIの認証エラーを適切に処理しなければならない
- **FR-015**: システムは日付ピッカーでの未来の日付の選択を防止しなければならない

### 主要エンティティ

- **睡眠セッション**: 開始時刻、終了時刻、および睡眠ステージのシーケンスを含む単一の睡眠期間を表す
- **睡眠ステージ**: タイムスタンプと期間を持つ4つの状態(深い睡眠、浅い睡眠、REM睡眠、覚醒)のいずれかでの連続期間を表す
- **日付選択**: 睡眠データを表示するためにユーザーが現在選択している日付を表す

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: 睡眠可視化画面を開いたときに、ローディング表示が出てユーザーにデータ取得中であることが明確に伝わる
- **SC-002**: 日付を選択したときに、グラフが新しい日付のデータに正しく更新される
- **SC-003**: 各睡眠ステージ（深い睡眠、浅い睡眠、REM睡眠、覚醒）が横方向タイムラインの各行として表示され、異なる色で視覚的に区別できる
- **SC-004**: 選択した日付のトータル睡眠時間が画面の右上にStackCordコンポーネントとして明確に表示される
- **SC-005**: カレンダー日付ピッカーで任意の過去の日付を選択できる（制限なし）
- **SC-006**: 睡眠データの可視化は、Fitbitによって記録されたすべての睡眠ステージをデータ損失なく正確に表現する

## 前提条件

- ユーザーはすでにFitbit OAuth2で認証されている(認証はアプリケーションの別の場所で処理される)
- 既存のアプリケーションには、Fitbit APIリクエストを行うためのインフラストラクチャがすでにある
- Fitbit APIからの睡眠データは、levels.data構造を持つ標準形式に従う
- アプリケーションはFlutterのfl_chartパッケージを使用している(既存のコードベース構造に基づく)
- ユーザーはアプリがFitbit睡眠データにアクセスするために必要な権限を付与している
- グラフはユーザーのローカルタイムゾーンで標準時刻形式を使用する
- 睡眠中の覚醒期間は、可視化される別個のステージと見なされる

## 依存関係

- Fitbit Web APIの可用性と認証
- アプリケーション内の既存のFitbit OAuth2認証フロー
- APIリクエストのためのネットワーク接続

## スコープ外

- 睡眠の質のスコアリングまたは分析
- 睡眠の推奨事項または洞察
- 複数の日付にわたる睡眠データの同時比較
- 睡眠データの他の形式へのエクスポート
- 睡眠目標の追跡または通知
- 他の睡眠追跡デバイスとの統合
